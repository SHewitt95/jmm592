<!DOCTYPE html>
<!-- Modification of Mike Bostock's code in http://bl.ocks.org/mbostock/1157787 -->
<meta charset="utf-8">
<style>

body {
  font: 10px sans-serif;
  margin: 20px;
  padding: 20px;
}

.line {
  fill: none;
  stroke: #666;
  stroke-width: 1.5px;
}

.area {
  fill: #e7e7e7;
}

.label {
  fill: steelblue;
}

.endpoint {
  fill: #666;
}

.y.axis text {
  fill: steelblue;
}

path.domain {
  fill: none;
  stroke: black;
  stroke-width: 1;
}

.tooltip {
  position: absolute;
  z-index: 10;
  background-color: white;
  border: gray 1px solid;
}

.tooltip p {
  padding: 2px;
  max-width: 180px;
}

</style>
<body>

  <h2>College Enrollment</h2>

  <p>Source: Data.gov, U.S. Department of Commerce, Census Bureau, Current Population Survey</p>

  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.6/d3.min.js"></script>
<script>


var fullheight = 150,
  fullwidth = 450;

var margin = {top: 30, right: 15, bottom: 20, left: 45},
    width = fullwidth - margin.left - margin.right,
    height = fullheight - margin.top - margin.bottom;

var parseDate = d3.time.format("Year %Y").parse;
var outputDate = d3.time.format("%Y");

var xScale = d3.scale.ordinal()
    .rangeRoundBands([0, width], .2);

var yScale = d3.scale.linear()
    .range([height, 0]);

var xAxis = d3.svg.axis()
    .scale(xScale)
    .orient("bottom")
    .innerTickSize([0]);

var yAxis = d3.svg.axis()
      .scale(yScale)
      .orient("left")
      .ticks(2)
      .outerTickSize(0)
      .innerTickSize(0)
      .tickFormat(d3.format("s"));

var tooltip;

var allTooltips = [];

//d3.select("h2").text("Total Deaths Due to " + illness + " 2000-2013");

d3.csv("Race_Gender_Education_Data.csv", typeFix, function(error, data) {

  //typeFix is a function that parses the dates and sets the strings to numeric. See below!
  console.log("data after load", data);

  var years = d3.keys(data[0]).filter(function(d) {
    // If d can be an actual a number (not a string), return it.
    if (+d) {
      return d;
    }
  });

  var nestByRaces = d3.nest()
    .key(function(d) { return d["Race_ethnicity"] })
    .entries(data);

  console.log(nestByRaces);

  xScale.domain(years);

  // Add an SVG element for each symbol, with the desired dimensions and margin:
  var svg = d3.select("body").selectAll("svg")
      .data(nestByRaces) // the data for each graph
    .enter().append("svg")
      .attr("width", fullwidth)
      .attr("height", fullheight)
    .append("g")
      .attr("transform", "translate(" + margin.left + "," + margin.top + ")")
      .each(multiple); // uses each to call the multiple code for each country

  function multiple(race) {

    //console.log(race);
    //console.log(race["values"][0]);
    var femaleValues = d3.values(race["values"][0]);
    //console.log("values", values);
    var yearValues = femaleValues.slice(0,13);
    //console.log("yearValues", yearValues);

    var thisSVG = d3.select(this);
    //var numbers = d3.values();
    //console.log("Max val", d3.max(yearValues));

    // Axes
    thisSVG.append("g")
        .attr("class", "x axis")
        .attr("transform", "translate(0," + height + ")")
        .call(xAxis)
        .selectAll("text")
          .attr("dy", ".5em")
          .attr("transform", "rotate(-30)")
          .style("text-anchor", "end");

    thisSVG.append("g")
        .attr("class", "y axis")
        .call(yAxis)
      .append("text")
        .attr("transform", "rotate(-90)")
        .attr("y", -33)
        //.attr("dy", ".71em")
        .style("text-anchor", "end")
        .text("Percentage of People");

        yScale.domain([0, d3.max(yearValues)]);

        // Adds graph title to each SVG.
        thisSVG.append("text")
              .attr("class", "label")
              .attr("x", width/2)
              .attr("y", -8)
              .style("text-anchor", "middle")
              .text(function(d) { return d["key"]; })

        var yearGroup = thisSVG
                    .append("g")
                    .attr("class", "years");

        var barGroups = yearGroup.selectAll("g.barGroup")
                  .data(years, function(d) {
                    return d;
                  })
                  .enter().append("g")
                  .attr("class", "barGroup");

        var bars = barGroups
                 .append("rect")
                 .attr("class", function(d) {
                   return "y" + d;
                 })
                 .style("fill", "orange")
                 .attr("x", function(d, i) {
                   return xScale(years[i]);
                 })
                 .attr("y", function(d, i) {
                   return yScale(yearValues[i]);
                 })
                 .attr("width", xScale.rangeBand())
                 .attr("height", function(d, i) {
                   return height - yScale(yearValues[i]);
                 });

          var barLabels = barGroups
                  .append("text")
                  .attr("class", "barLabel")
                  .attr("x", function(d, i) {
                    return xScale(years[i]);
                  })
                  .attr("y", function(d, i) {
                    return yScale(yearValues[i]);
                  })
                  .attr("dx", 11)
                  .attr("dy", 12)
                  .style("text-anchor", "middle")
                  .text(function(d, i) {
                    if (yearValues[i] != 0) {
                      return yearValues[i];
                    }
                  });


          //bars
            //.on("mouseover", mouseover)
            //.on("mousemove", mousemove)
            //.on("mouseout", mouseout);



        //console.log(yearGroup.data());

  } // end of the multiple function

  function mouseover(d) {
    var query = "rect." + "y" + d;
    var allYearBars = d3.selectAll(query)
      .transition()
      .style("stroke", "black");

    allTooltips = makeToolTips(allYearBars);

    allTooltips.forEach(function(d, i) {
      d.style("display", null)
  					 /*.html("<p>Year: " + d.year + "</p>"
  					 			+ "<p>Race: " + d["key"] + "</p>"
  					 			+ "<p>Percent: " + d.percent + "%</p>"
  				 		)*/
              .html(function(e, i) {
                console.log(e);
              })

    });

  }

  function mouseout(d) {
    var query = "rect." + "y" + d;
    var allYearBars = d3.selectAll(query)
				.transition()
				.style("stroke", "none");

			//tooltip.style("display", "none");  // this sets it to invisible!

      allTooltips.forEach(function(d) {
        d.remove();
      });
	}

  function mousemove(d) {
    allTooltips.forEach(function(d) {
      d.style("top", (d3.event.pageY - 10) + "px" )
      .style("left", (d3.event.pageX + 10) + "px");
    });

  }

  function makeToolTips(allYearBars) {
    var data;
    var tooltipsToReturn = [];

    allYearBars.each(function(d) {
      tooltip = d3.select("body").append("div").attr("class", "tooltip");
      data = d3.select(this.parentNode.parentNode).data();
      tooltip.data(data);
      tooltipsToReturn.push(tooltip);
    });

    return tooltipsToReturn;
  }

});

function typeFix(d) {
  var i;
  for (i = 2000; i < 2013; i++) {
    d[i] = +d[i];
  }
  return d;
}

</script>
